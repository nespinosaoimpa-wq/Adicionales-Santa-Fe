<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auth - Adicionales SF</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
            width: 100%;
        }

        #log {
            background: #000;
            border: 2px solid #00ff00;
            padding: 15px;
            margin-top: 20px;
            min-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }

        .error {
            color: #ff0000;
        }

        .success {
            color: #00ff00;
        }

        .info {
            color: #ffff00;
        }
    </style>
</head>

<body>
    <h1>üîç Diagn√≥stico de Autenticaci√≥n</h1>
    <p>Esta p√°gina te ayudar√° a identificar el problema exacto.</p>

    <button onclick="testConfig()">1. Verificar Configuraci√≥n Firebase</button>
    <button onclick="testGooglePopup()">2. Probar Google Login (Popup)</button>
    <button onclick="testGoogleRedirect()">3. Probar Google Login (Redirect)</button>
    <button onclick="clearAll()">üóëÔ∏è Limpiar Todo (Cach√© + Storage)</button>

    <div id="log"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const log = document.getElementById('log');

        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${time}] ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAQcFLomEYkLjk9da08u2mAiO49pbpn6wU",
            authDomain: "adicionales-santa-fe.firebaseapp.com",
            projectId: "adicionales-santa-fe",
            storageBucket: "adicionales-santa-fe.firebasestorage.app",
            messagingSenderId: "633828043228",
            appId: "1:633828043228:web:c417d3a92ae07a2e550719"
        };

        addLog("Inicializando Firebase...", "info");
        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            addLog("‚úÖ Firebase inicializado correctamente", "success");
        } catch (e) {
            addLog("‚ùå Error al inicializar Firebase: " + e.message, "error");
        }

        function testConfig() {
            addLog("=== VERIFICANDO CONFIGURACI√ìN ===", "info");
            addLog("Project ID: " + firebaseConfig.projectId, "info");
            addLog("Auth Domain: " + firebaseConfig.authDomain, "info");
            addLog("Current URL: " + window.location.href, "info");
            addLog("User Agent: " + navigator.userAgent, "info");

            // Check if popup is blocked
            const popup = window.open('', '_blank', 'width=1,height=1');
            if (popup) {
                popup.close();
                addLog("‚úÖ Popups permitidos", "success");
            } else {
                addLog("‚ùå Popups bloqueados - esto causar√° errores", "error");
            }
        }

        async function testGooglePopup() {
            addLog("=== PROBANDO GOOGLE POPUP ===", "info");
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({
                    prompt: 'select_account'
                });

                addLog("Abriendo popup de Google...", "info");
                const result = await auth.signInWithPopup(provider);

                addLog("‚úÖ ¬°LOGIN EXITOSO!", "success");
                addLog("Usuario: " + result.user.email, "success");
                addLog("Nombre: " + result.user.displayName, "success");
                addLog("UID: " + result.user.uid, "success");

            } catch (error) {
                addLog("‚ùå ERROR EN POPUP:", "error");
                addLog("C√≥digo: " + error.code, "error");
                addLog("Mensaje: " + error.message, "error");

                if (error.code === 'auth/unauthorized-domain') {
                    addLog("‚ö†Ô∏è PROBLEMA: Dominio no autorizado en Firebase Console", "error");
                    addLog("Soluci√≥n: Agregar este dominio en Firebase Console > Authentication > Settings > Authorized domains", "info");
                } else if (error.code === 'auth/popup-blocked') {
                    addLog("‚ö†Ô∏è PROBLEMA: Popup bloqueado por el navegador", "error");
                    addLog("Soluci√≥n: Permitir popups para este sitio", "info");
                } else if (error.code === 'auth/popup-closed-by-user') {
                    addLog("‚ö†Ô∏è Usuario cerr√≥ el popup", "info");
                }
            }
        }

        async function testGoogleRedirect() {
            addLog("=== PROBANDO GOOGLE REDIRECT ===", "info");
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                addLog("Redirigiendo a Google...", "info");
                await auth.signInWithRedirect(provider);
            } catch (error) {
                addLog("‚ùå ERROR EN REDIRECT:", "error");
                addLog("C√≥digo: " + error.code, "error");
                addLog("Mensaje: " + error.message, "error");
            }
        }

        async function clearAll() {
            addLog("=== LIMPIANDO TODO ===", "info");

            // Clear localStorage
            localStorage.clear();
            addLog("‚úÖ localStorage limpiado", "success");

            // Clear sessionStorage
            sessionStorage.clear();
            addLog("‚úÖ sessionStorage limpiado", "success");

            // Clear IndexedDB
            if (window.indexedDB) {
                const dbs = await indexedDB.databases();
                for (const db of dbs) {
                    indexedDB.deleteDatabase(db.name);
                    addLog("‚úÖ IndexedDB eliminado: " + db.name, "success");
                }
            }

            // Unregister service workers
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    await registration.unregister();
                    addLog("‚úÖ Service Worker desregistrado", "success");
                }
            }

            addLog("üîÑ Recarga la p√°gina en 3 segundos...", "info");
            setTimeout(() => window.location.reload(true), 3000);
        }

        // Check redirect result on load
        window.addEventListener('load', () => {
            auth.getRedirectResult().then((result) => {
                if (result && result.user) {
                    addLog("‚úÖ ¬°REDIRECT EXITOSO!", "success");
                    addLog("Usuario: " + result.user.email, "success");
                    addLog("Nombre: " + result.user.displayName, "success");
                }
            }).catch((error) => {
                if (error.code) {
                    addLog("‚ùå Error en redirect result:", "error");
                    addLog("C√≥digo: " + error.code, "error");
                    addLog("Mensaje: " + error.message, "error");
                }
            });
        });
    </script>
</body>

</html>
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Función helper: verificar si el usuario es admin ──
    function isAdmin() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.token.email)) &&
        get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.role == 'admin';
    }

    // ── USUARIOS: cada usuario solo puede leer/editar su propio perfil ──
    match /users/{userEmail} {
      allow read: if request.auth != null && (
        request.auth.token.email.lower() == userEmail.lower() || isAdmin()
      );
      allow write: if request.auth != null &&
        request.auth.token.email.lower() == userEmail.lower();
      // Solo admin puede actualizar el campo 'role'
      allow update: if isAdmin();
    }

    // ── SERVICIOS: solo el dueño puede leer/escribir sus servicios ──
    match /services/{serviceId} {
      allow read, delete: if request.auth != null &&
        request.auth.token.email.lower() == resource.data.userEmail.lower();
      allow create: if request.auth != null &&
        request.auth.token.email.lower() == request.resource.data.userEmail.lower();
      allow update: if request.auth != null &&
        request.auth.token.email.lower() == resource.data.userEmail.lower();
      // Admin puede leer todos para el panel
      allow read: if isAdmin();
    }

    // ── GASTOS: solo el dueño puede leer/escribir ──
    match /expenses/{expenseId} {
      allow read, delete: if request.auth != null &&
        request.auth.token.email.lower() == resource.data.userEmail.lower();
      allow create: if request.auth != null &&
        request.auth.token.email.lower() == request.resource.data.userEmail.lower();
      allow update: if request.auth != null &&
        request.auth.token.email.lower() == resource.data.userEmail.lower();
    }

    // ── PUBLICIDAD: lectura pública, escritura y eliminación solo admin ──
    match /ads/{adId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ── RESEÑAS Y FEEDBACK: solo el dueño crea, solo admins leen todas ──
    match /reviews/{reviewId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && (
        resource.data.user_email == request.auth.token.email || isAdmin()
      );
      allow delete: if isAdmin();
      allow update: if false;
    }

    // ── LOGS DE CENTINELA: solo el dueño crea, solo admins leen ──
    match /query_logs/{logId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && (
        resource.data.user_email == request.auth.token.email || isAdmin()
      );
      allow delete: if isAdmin();
      allow update: if false;
    }
  }
}
